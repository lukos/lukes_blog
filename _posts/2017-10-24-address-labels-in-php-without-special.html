---
layout: post
title: Address labels in PHP without special software
date: '2017-10-24T12:08:00.001-07:00'
author: Luke Briner
tags:
- fpdf
- yii2
- address labels
- PDF
- php
modified_time: '2017-10-24T12:08:18.799-07:00'
---

This sounded like a simple job. Print out address labels from a database in a certain format (8 x 2 labels on a page) in a way that can then be printed directly onto the label sheets. Easy right?<br /><br />Not so much. HTML and CSS3 is supposed to add a load of print functionality and physical sizes but they don't work well at all. Browser treat them all differently, Chrome applies margins in addition to what you set in CSS so everything gets squashed and whatever I tried, it didn't seem to make sense. On top of that, the Developer tools allow you to render using the print css but this does not really allow a real print preview while tweaking the styles.<br /><br />Fortunately, I chanced upon a suggestion to use FPDF, a PHP library to generate PDFs in code. It looked easy enough although unfortunately, you cannot simply create a fixed size "cell" and wrap text in it. A Cell is one line of text and multi-cell will simply create more cells for each new line of text. Not quite right but fortunately, using the position functions setX, setY etc. the maths is relatively simple to keep track of column number, row number and then work out where to add a new page.<br /><br />Use the following code as a reference - note it is from Yii 2 framework and so some of this won't be relevant to you. Then check out the notes below for additional help.<br /><br /><pre style="background-color: #eeeeee; border: 1px dashed #999999; color: black; font-family: &quot;andale mono&quot; , &quot;lucida console&quot; , &quot;monaco&quot; , &quot;fixed&quot; , monospace; font-size: 12px; line-height: 14px; overflow: auto; padding: 5px; width: 100%;"><code>public function actionAddresslabels()<br />{<br />    $request = \Yii::$app-&gt;request;<br /><br />    // Set defaults for layout<br />    $cols = $request-&gt;get('cols', 2);           // Number of columns<br />    $rows = $request-&gt;get('rows', 8);           // Number of rows<br />    $top = $request-&gt;get('top', 8);             // Top margin in mm<br />    $left = $request-&gt;get('left', 5);           // Left margin in mm<br />    $vspacing = $request-&gt;get('vspacing', 0);   // Spacing vertically between each label in mm (excludes outside margins)<br />    $hspacing = $request-&gt;get('hspacing', 2.5);   // Spacing horizontally between columns in mm (excludes outside margins)<br />    $padding = $request-&gt;get('padding', 3);<br /><br />    // Compute some numbers<br />    $pageSize = $rows * $cols;<br />    $colSpacing = (210.0 - (2*$left) + $hspacing) / ($cols);<br />    $rowSpacing = (297.0 - (2*$top) + $vspacing) / ($rows);<br /><br />    $dataProvider = new ActiveDataProvider([<br />        'query' =&gt; User::find()<br />            -&gt;joinWith(['applications'])<br />            -&gt;where(['year' =&gt; Date('Y')]),<br />        'pagination' =&gt; false,<br />    ]);<br /><br />    // Load data into local variables for loop<br />    $models = $dataProvider-&gt;getModels();<br />    $modelCount = $dataProvider-&gt;getCount();<br />    $currentModel = 0;<br />    $currentY = 0;<br />    $currentX = 0;<br /><br />    // Basic setup of PDF<br />    $pdf = new FPDF();<br />    $pdf-&gt;SetLeftMargin($left + $padding);<br />    $pdf-&gt;SetTopMargin($top + $padding);<br />    $pdf-&gt;SetFont('Arial','',11);<br />    $pdf-&gt;SetAutoPageBreak(false);<br /><br />    // For each cols x rows of addresses, add a page and render them correctly<br />    while ( $currentModel &lt; $modelCount )<br />    {<br />        if ( $currentModel % $pageSize === 0)<br />        {<br />            $pdf-&gt;AddPage();<br />            $currentX = $left + $padding;<br />            $currentY = $top + $padding;<br />        }<br />        $pdf-&gt;SetXY($currentX,$currentY);<br />        $pdf-&gt;SetLeftMargin($currentX);<br />        $model = $models[$currentModel];<br />        $this-&gt;writeAddressLabel($pdf, $model);<br />        $currentY += $rowSpacing;<br />        if ( $currentY &gt; (297 - 20) )<br />        {<br />            $currentY = $top + $padding;<br />            $currentX += $colSpacing;<br />        }<br />        $currentModel++;<br />    }<br /><br />    $this-&gt;layout = false;<br />    \Yii::$app-&gt;response-&gt;format = \yii\web\Response::FORMAT_RAW;<br />    $pdf-&gt;Output();<br />    \Yii::$app-&gt;end();<br />}<br /></code></pre><br /><br /><ul><li>The first section allows you to pass different values from the defaults into the query string for this action.</li><li>$padding allows all the text to be in from the top-left corner of each label and needs to be included in various calculations</li><li>The second section does some calculations for page size (number of labels total per page), column and row spacing are the pitch values so include the gutters between the labels.</li><li>The ActiveDataProvider is simply how I am querying the people to produce labels for. What I end up with is an array of objects ($models) that I will pull the individual address parts from.</li><li>$modelCount is simply used to control how long the loop below will continue for</li><li>The next section sets some static values for the PDF instance. The margins will shift all of the setXY stuff in from the edges of the page.</li><li>The main loop goes through all of the "users" in my models array 1 by one.&nbsp;</li><li>The first section inside the loop uses mod arithmetic to see whether the current item is the first on a page, in which case a new page is created, and the X and Y positions are reset (they are relative to the current page, not the entire document).</li><li>The cursor is then positioned with SetXY</li><li>SetLeftMargin is called to ensure the current column has a hard left edge, otherwise the text becomes indented.</li><li>The method WriteAddressLabel is a helper method in my class that simply contains a number of calls to&nbsp;$pdf-&gt;Write(5,$model-&gt;town.PHP_EOL); With some wrapped in&nbsp;if ( $model-&gt;address3 !== "") so that they are not printed if blank. In your code, they might equate to null but in my code, they are blank strings if not set.</li><li>After the address is written, the Y position is moved down by a label pitch and then if this goes below the bottom of the page (hard-coded for A4 paper size 297mm minus a margin), then the column is incremented, Y is reset back to the top. We do not need to check for the column overflowing the page, since the mod arithmetic at the top of the loop will automatically create a new page when we have written the total number of items on the page.</li><li>The 4 lines below the loop are partly methods to tell Yii to output the correct format and not render a HTML layout and the call to $pdf-&gt;Output() closes the document and sends it to the standard output, which in this case is the response object.</li></ul><br /><br />
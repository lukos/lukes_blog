---
layout: post
title: Fully working Azure diagnostics example including log4net
date: '2014-02-24T05:54:00.002-08:00'
author: Luke Briner
tags:
- example
- examples
- Azure
- filter
- DiagnosticMonitorTraceListener
- log4net
- diagnostics
modified_time: '2014-02-24T06:01:10.289-08:00'
---

<h2>Introduction </h2>Azure diagnostics has been a pain for me for the past 6 months. It hasn't been working properly but it always seems to take so long to debug that it is easier to forget about it...except of course logging is ESSENTIAL for any useful working system. If people are seeing errors, it is sometimes possible to debug by looking at the code but if not, you need a specific error message or exception to be logged somewhere readable. The problem might not be caused by you but by the cloud host or whatever so you need to know what's what.<br /><br />Anyway....I have just installed the latest version of the Azure SDK (v2.2) and I know some things have been changed recently in the SDK so I cannot promise this will work in the same way on the earlier versions of the SDK.<br /><br /><h2>Step 1 - Add log4net (optional)</h2>This step is optional but I have chosen to use log4net for reasons that include the ability to send emails with any errors - especially useful in the early days where I don't expect too many! Also, it is very easy to configure multiple appenders in log4net in a pretty consistent way. You can log to file while debugging locally etc.<br /><br />In NuGet there is now a log4net package so simply go into Visual Studio and select Tools &gt; Library Package Manager &gt; Manage NuGet Packages for Solution (or alternatively, right-click the references folder of a project and select Manage NuGet Packages) and then search for log4net. This will add not only the dll but also an assembly redirect into your web.config and also a configuration section.<br /><br />Optionally, you can move the log4net configuration out of web.config and into its own file. I have done this to keep web.config smaller. If you do this, web.config needs to contain:<br /><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&lt;log4net configsource="log4net.config"&gt;</span><br /><br />This is placed under the configuration element. Your log4net config file needs to have the following at the root level:<br /><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&lt;?xml version="1.0" encoding="utf-8" ?&gt;<br />&nbsp; &lt;log4net&gt;</span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">etc...</span><br /><br />You also need to do 2 things to make the log4net system work correctly. I used to only do the first of these but recently, it seems that the second is also required but I don't know whether that is because of other changes I have made&gt;<br /><br />1) Add the following to your global.asax code file above the namespace declaration. I think this can also go in AssemblyInfo.cs:<br /><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">[assembly: log4net.Config.XmlConfigurator(ConfigFile="log4net.config", Watch=false)]</span><br /><br />2) Wake up log4net by calling the following code in your Application_Start method in global.asax:<br /><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">XmlConfigurator.Configure();</span><br /><h2>Step 2 - Adapt the log4net TraceAppender </h2>If you are using log4net, the default TraceAppender does not understand the standard .Net logging levels which mean everything gets logged as Verbose level. It is easy to modify this behaviour by extending log4net.Appender.TraceAppender in your own code and map between the log4net and .Net logging levels:<br /><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">public class <b>AzureTraceAppender </b>: TraceAppender<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protected override void Append(LoggingEvent loggingEvent)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var level = loggingEvent.Level;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var message = RenderLoggingEvent(loggingEvent);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (level &gt;= Level.Error)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Trace.TraceError(message);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else if (level &gt;= Level.Warn)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Trace.TraceWarning(message);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else if (level &gt;= Level.Info)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Trace.TraceInformation(message);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Trace.Write(message);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (ImmediateFlush)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Trace.Flush();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; }</span><br /><br />When referencing this appender in your log4net config, you need to reference it by namespace and the name of your project output assembly:<br /><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&lt;appender name="TraceAppender" type="namespace.to.AzureTraceAppender, YourAssemblyName"&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;layout type="log4net.Layout.PatternLayout"&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;conversionpattern value="%date [%thread] %-5level %logger [%property{NDC}] - %message%newline"&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/conversionpattern&gt;&lt;/layout&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;threshold value="INFO"/&gt;<br />&nbsp;&nbsp;&nbsp; &lt;/appender&gt;</span><br /><br /><h2>Step 3 - Extend DiagnosticMonitorTraceListener</h2>The reason for this as stated in my <a href="http://lukieb.blogspot.co.uk/2014/02/bug-diagnosticmonitortracelistener.html" target="_blank">previous post</a> is that the Azure version does not honour the "filter" element and therefore dumps everything into the log file. This is a pain in Azure for the simple reason that there are loads of Azure platform events about things I don't even understand. This very quickly makes the logs unusable without some special tool to parse them. My previous post tells how to extend this MS class to add in the filtering functionality.<br /><br /><h2>Step 4 - Modify web.config to use the trace listener</h2>web.config is normally where you specify your trace listeners. What these listeners do is they listen to trace sources (which in my case are created via log4net) and then they do something with these events as they are logged. The diagnostic monitor trace listener logs to file on your Azure machine in a special XML format which is why later we need to copy this data to somewhere more useful.<br /><br />In my web config, I have the following entry:<br /><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&lt;system.diagnostics=""&gt;<br />&nbsp;&nbsp;&nbsp; &lt;trace autoflush="true"&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;listeners&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;clear /&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;add name="AzureDiagnostics" type="namespace.to.DiagnosticMonTraceListener, YourAssemblyName"&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;filter initializedata="Error" type="System.Diagnostics.EventTypeFilter"&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/filter&gt;&lt;/add&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/listeners&gt;<br />&nbsp;&nbsp;&nbsp; &lt;/trace&gt;<br />&nbsp; &lt;/system&gt;</span><br /><br />And you will note I am only interested in Errors. If I used the MS version of this trace listener, that error filter would make no difference to the output.<br /><br /><h2>Step 5 - Remove any redundant code from WebRole.cs</h2>This is the default class name for the role entry point and used to be required to setup diagnostic transfer information but that can now all be done in the role configuration itself and is no longer needed in OnStart. All mine does is call the base class OnStart() - you might have other code in here unrelated to diagnostics though.<br /><br /><h2>Step 6 - Configure your transfers</h2>Double-click the role in your cloud project to open up the role configuration pages and notice the diagnostics section at the bottom of the first page:<br /><br /><br /><img alt="" src="data:image/png;base64,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" /><br /><br />Ensure that Enable Diagnostics is ticked and then choose "Custom plan". Click the Edit button and set your options for transferring the event and application logs. It is up to you when to do these but the default is to transfer every 1 minute for the Application and Event logs and to choose verbose to copy off all messages (we are filtering in the application so it is OK to set verbose here).<br /><br />By default, this will copy the data into the specified storage account for your application and into tables with fixed names: WADLogsTable (for events) and WADWindowsEventLogsTable for application events.<br /><br /><h2>Step 7 - Log events from your code</h2>How you do this will depend on whether you are using log4net or directly using the MS logging. If you are using log4net, create a private static log variable at the top of each class like this:<br /><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">private static readonly log4net.ILog log = log4net.LogManager.GetLogger(typeof(MyClassName));</span><br /><br />and then call it in the following form:<br /><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">log.Warn("OAuth2 invalid request");</span><br /><br />You can also pass an exception as the second argument.<br />If you are not using log4net, then the logging is simply done like the following with no variable required:<br /><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">Trace.TraceError("Some message", optionalException);</span><br /><br /><h2>Step 8 - Debugging</h2>I have had various problems in the past and if you have any problems, as with most debugging, the best idea is to start with a very simple example and not using log4net. Put a single Trace.TraceError() call in your class. Use the MS version of DiagnosticMonitorTraceListener with no filter in your web.config and see if you can get that simple example working. Then replace DiagnosticMonitorTraceListener with your own version without/with a filter and each time work out whether it is working.<br /><br />Remember it takes some time for the data to be transferred into the tables (depending on what you set as the transfer time). <br /><br />From experience, the two most likely problems are incorrectly specified types in web.config or log4net.config (typos or using the wrong name for the assembly) or using the wrong versions or combinations of versions of the windows azure SDK dlls.<br /><br />You can enable Remote Desktop on your roles, which will allow you to see the windows logs on the role itself if you are having problems - especially if the problems aren't causing any useful exceptions. log4net is designed to fail quietly!<br /><br />Check your logging levels to make sure your events are not being filtered out at some point. log4net and the web.config entries as well as the diags config in your role can all affect whether a specific event level is passed through or blocked.<br /><br />Sometimes, you might get an error logged about things that are incorrect (like configuration) but which somehow are still able to be logged. Pay attention to these because it is possible that the configuration you think you are using is not being loaded because of errors.<br /><br /><h2>How to read the logs</h2>The logs are stored in Azure table storage so any tool that can read these tables can read the event information. I use Azure Storage Explorer (which is free) but there are others including CloudXplorer (not free but evaluation version available). The format of the data is quite extensive but you should be able to work out what you need once you read it.
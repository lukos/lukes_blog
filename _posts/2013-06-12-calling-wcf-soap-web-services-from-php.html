---
layout: post
title: Calling WCF SOAP web services from PHP
date: '2013-06-12T09:33:00.000-07:00'
author: Luke Briner
tags:
- SOAP
- ".net"
- client certificates
- web services
- WCF
- calling .net from PHP
- php5
- php
modified_time: '2013-06-12T09:33:44.993-07:00'
---

Why would I want to? There are two reasons why this might be necessary, firstly, there might be a third-party web service that is SOAP and secondly, as in my case, I need a PHP web service but it needs to use functionality that does not readily exist in PHP but does in .Net - so I will call a .Net web service to do the heavy lifting.<br /><br />In my case, the requirements are:<br /><ol><li>Fairly standard WCF web service</li><li>Transport security (https)</li><li>Client certificate security</li><li>SOAP 1.2</li><li>PHP 5.3 SOAP client </li></ol>Now, I eventually got this to work using the code below but by all means try and remove some of the options to see if they are already set. As for me, I kept making changes until it worked. <br /><br /><pre style="background-color: #eeeeee; border: 1px dashed #999999; color: black; font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; font-size: 12px; line-height: 14px; overflow: auto; padding: 5px; width: 100%;"><code>$protected_url = "https://path.to.your/WebService.svc?wsdl";<br />$my_cert_file = Yii::getPathOfAlias( 'webroot' ) . "/login.pem";<br /><br />$client = new SoapClient($protected_url, array('local_cert' =&gt; $my_cert_file, <br />                                              'soap_version' =&gt; SOAP_1_2,<br />                                              'trace' =&gt; TRUE) );<br />$actionHeader = array( new SoapHeader('http://www.w3.org/2005/08/addressing',<br />                      'Action',<br />                      'http://path.to.your/namespace/interfacename/CheckImage'),<br />                      new SoapHeader('http://www.w3.org/2005/08/addressing',<br />                      'To',<br />                      'https://path.to.your/WebService.svc/endpointname')<br />                      );<br />$client-&gt;__setSoapHeaders($actionHeader);<br />try<br />{<br />    $something = $client-&gt;CheckImage(array('userId' =&gt; "23",'imagename' =&gt; 'test'));<br />}<br />catch(Exception $e)<br />{<br />   $this-&gt;sendResponse(500, $client-&gt;__getLastRequest(),FALSE);<br />}<br />$this-&gt;sendResponse(200, $something);<br /></code></pre><br />So, what's going on? The first url is where the soap client will retrieve the WSDL from. In WCF, the standard location is the service name with ?wsdl on the end. There is also a similar wsdl with ?singleWsdl on the end but I don't know the difference (maybe this was my problem!).<br /><br />The second line, in my case, is just building a path to a locally installed client certificate (in my case, I am using Yii).<br /><br />When creating the client, I have to specify the client certificate and the soap version in the options array. I also set trace to TRUE and this allows me to use __getLastRequest() later on if I have problems.<br /><br />I had various SOAP errors and these were related to missing headers which meant the endpoint filters were complaining, so I specify these as additional headers. If you search your wsdl for your function <wsdl:operation name="functionname">, you will find an Action attribute that has this information in it. For the "To" header, similarly, you can find this under the relevant endpoint as the value of <address> (which might also have a namespace like wsa10:Address).</address></wsdl:operation><br /><br />The try block calls the name of my function and passes in an associative array of parameters. This allows the endpoint to marshall them to the correct positions in the function.<br /><br />In my case, if an error occurs, I return the value of __getLastRequest() to the caller and this returns the XML that was sent to the web service. This is really helpful when things don't seem to work because you can compare it with known good calls that you could make from .Net to .Net.<br /><br />sendResponse is just a helper method that I use to return HTTP codes.
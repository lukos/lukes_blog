---
layout: post
title: Tip of the day - learn how to enable logging on any new product
date: '2021-04-30T09:32:00.002-07:00'
author: Luke Briner
tags:
- docker
- envoy
- grpc
- kestrel
- tls
modified_time: '2021-04-30T09:32:37.389-07:00'
---

<p>&nbsp;I have been wrestling with getting Envoy proxy to work with a dotnet core grpc service and really struggling. The dotnet core end is surprisngly easy and works when called from a test client. Configuring envoy to work is a pain, when you don't know how to enable various logging.</p><p>I had no end of problems one after the other understanding ports, hostnames, tls setup etc. and this wasn't helped by Envoy's rather information-oriented documentation which doesn't include the rich guides that some frameworks have to setup specific recipes. I am also wary of systems that have so much setup by default so that if you don't flick a switch, it doesn't go bang, it just does what it wants, leaving you unsure whether you have misconfigured it or whether the problem is elsewhere.</p><p></p><p>Anyway, the perpetual problem was this error:</p><p><span style="-webkit-text-stroke-width: 0px; background-color: #253138; color: #aed9fa; display: inline !important; float: none; font-family: monospace; font-size: 12px; font-style: normal; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-decoration-color: initial; text-decoration-style: initial; text-decoration-thickness: initial; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;">upstream connect error or disconnect/reset before headers. reset reason: remote reset</span></p><p>Which means pretty much anything that does not permit the proxy to contact the web service. Wrong port or hostname (usually get connection refused but not always). I only worked it out by enabling another load of logging on the webservice as well. That shows this error:</p><p>&nbsp;<br /><span style="-webkit-text-stroke-width: 0px; background-color: #253138; color: #aed9fa; display: inline !important; float: none; font-family: monospace; font-size: 12px; font-style: normal; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-decoration-color: initial; text-decoration-style: initial; text-decoration-thickness: initial; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;"><span style="-webkit-text-stroke-width: 0px; background-color: #253138; color: #aed9fa; display: inline !important; float: none; font-family: monospace; font-size: 12px; font-style: normal; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-decoration-color: initial; text-decoration-style: initial; text-decoration-thickness: initial; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;">The request :scheme header 'http' does not match the transport scheme 'https'</span></span></p><p>Which fortunately makes sense - but why is it happening? I then learned how to override the entrypoint for envoy proxy to enable debug logging. It's a shame you can't set this in config (unless it just isn't documented well enough)</p><p>ENTRYPOINT /docker-entrypoint.sh envoy -c /etc/envoy/envoy.yaml -l debug</p><p>This prints a load of stuff in the logs for the envoy container but then it is really easy to see what is happening with more details. Did it resolve the hostname? Did it manage to make a TLS connection? In my case, I could see the service was called and responded with a 200 message containing a grpc error which was the weird one about remote reset. More importantly, I could see the <i>request</i> headers and saw that it was sending :scheme http instead of https. Why? I would have thought the TLS setup would automatically set this and if not, I couldn't find any documentation about it so maybe not many people are using http2 + TLS + kestrel for their control planes? Maybe I need to disable the scheme check on the webservice if possible?<br />&nbsp;</p><p>Anyway, I raised a bug on the envoy project so let's see what happens with it!</p><p>ABL - Always be logging!<br /><br /><br /><br /></p>
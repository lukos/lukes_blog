---
layout: post
title: Filebeat as a Webjob on App Services to send IIS logs to Logstash
date: '2018-01-31T05:42:00.001-08:00'
author: Luke Briner
tags:
- webjobs
- elk
- filebeat
- Elasticsearch
- logging
- Logstash
- app services
- iis
modified_time: '2018-01-31T05:42:26.187-08:00'
---

I am struggling getting certain parts of my ELK stack setup but surprisingly, setting up FileBeat to forward logs from IIS in App Services worked first time!<br /><br />Filebeat is a lightweight exe that can do some very basic log parsing and forwarding, either directly to ElasticSearch or more likely via Logstash, which is a much heavier weight and scalable application that can perform various parsing and modifications of messages before they go into ElasticSearch. In this case, IIS logs should be modified in LogStash to give them more useful metadata.<br /><br />Logstash is too big and resource hungry to use on App Services (unless it was installed centrally somewhere but that would likely not work well) but fortunately, FileBeat measures in at about 30MB expanded and 8MB in a zip file which is easily small enough for App Services.<br /><br />The steps are straight-forward and this worked for me with v6.1.1 of filebeat for Windows.<br /><br /><br /><ol><li>Download filebeat and extract the contents to a folder somewhere to edit</li><li>You can delete the install and uninstall as a service PS scripts as well as the reference yml file to save a few KB!</li><li>Add a file called run.cmd which includes the command line&nbsp;.\filebeat.exe -e</li><li>It is recommended that you test filebeat locally first to ensure your pipeline is working before you bring Azure into the mix but if you already know that works, you can skip that step.</li><li>Edit filebeat.yml using the code as shown at the bottom (keep other stuff if you know you need it). The only specific bit for App Services is the log path.</li><li>ZIP the contents of your extracted folder by selecting all files and folders in the directory that contains filebeat.exe and choosing <b>Send to compressed (zipped) folder</b>. Do NOT do this on the parent directory, otherwise the zip will include the parent directory at the top level. Call it something like webjob.zip</li><li>In the Azure portal, select the App Service you want to use, choose Web Jobs and the&nbsp;+ button to add a new one.</li><li>Choose a name, select Continuous as a type and select the ZIP file you created, choose multi-instance if these needs to run on every instance of your app (it probably will need to unless you are testing) and press OK.</li><li>It will run immediately so make sure that your endpoint is running correctly</li></ol><blockquote class="tr_bq">Note: The path used on App Services works on my current setup but I cannot tell whether this drive letter and path is guaranteed not to change! I don't currently know how to query the logs directory using e.g. an environment variable.</blockquote><div><br /></div><br /><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">#=========================== Filebeat prospectors =============================</span></div><div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">filebeat.prospectors:</span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">- type: log</span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; # Change to true to enable this prospector configuration.</span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; enabled: true</span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; # Paths that should be crawled and fetched. Glob based paths.</span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; paths:</span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; - D:\home\LogFiles\http\RawLogs\*.log</span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; # Exclude lines. A list of regular expressions to match. It drops the lines that are</span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; # matching any regular expression from the list.</span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; exclude_lines: ['^#']</span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">#============================= Filebeat modules ===============================</span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">filebeat.config.modules:</span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; # Glob pattern for configuration loading</span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; path: ${path.config}/modules.d/*.yml</span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; # Set to true to enable config reloading</span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; reload.enabled: false</span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">#==================== Elasticsearch template setting ==========================</span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">setup.template.settings:</span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; index.number_of_shards: 1</span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; #index.codec: best_compression</span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; #_source.enabled: false</span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">#----------------------------- Logstash output --------------------------------</span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">output.logstash:</span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; # The Logstash hosts</span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; hosts: ["logstash.example.com:5044"]</span></div></div><div><br /></div>
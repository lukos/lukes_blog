---
layout: post
title: Cassette Bundling and Minification
date: '2012-11-06T06:12:00.000-08:00'
author: Luke Briner
tags:
- minification
- bundling
- cassette
modified_time: '2012-11-06T06:12:16.559-08:00'
---

<h2>Introduction </h2>It is nice when you discover features that have been added to Visual Studio which match best practice, things like bundling and minification to speed up web page downloads. However, what is not good is realising that even though it looks like these resources have cache-busting, they do not. This removes the whole ability to set long expiration times for scripts and css and only download them when they change.<br /><h2>Cassette </h2>I then discovered Cassette (getcassette.net) which provides the same functionality but also includes cache busting for any changed files.<br />First note is the documentation is pretty weak at the moment, although the Cassette google group seems to be supported well by the author(s). The other issue, related to the first, is that it is easy to get an error in the configuration which doesn't always manifest very obviously and therefore requires some poking around to work out what is actually wrong.<br /><h3>Setup</h3>Setup is pretty easy using nuget (the package manager in visual studio) this adds a few assemblies and some web.config as well as a file called CassetteConfiguration.cs. As with all these nuget packages, be careful that the correct project is selected at the top of the package manager console before getting the package.<br />Secondly, remove either the Cassette config from system.web (IIS6) or that from system.webserver (IIS7) depending on what you run it on. I think this was causing some issue for me but it is possible that it is safe to keep both sections in and my issues were elsewhere.<br /><h3>Configuration</h3>You will see a couple of examples in the configuration class but be aware that there are lots of different flavours of the Add function and these do different things. If you get these wrong, you will generally get an internal server error which will not print on your screen and which may or may not be raised in the debugger. The best is to start one at a time and bring things in.<br />Specifically, you need to be careful to distinguish between directory names, file names and alias names which are the first arguments to the Add functions.<br /><br />Note here that bundling is a compromise between having a single downloaded file (which requires less connections and overhead to download) but not wanting any change to any of these files to require the whole lot to be downloaded again. Per-directory is a good compromise otherwise consider unchanging content (framework js and css) vs app-specific files. You can also consider common content vs page-specific content. <br /><br />Example 1 - Add everything under directory Content but keep them in individual files:<br /><br /><pre style="background-color: #eeeeee; border: 1px dashed #999999; color: black; font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; font-size: 12px; line-height: 14px; overflow: auto; padding: 5px; width: 100%;"><code>bundles.AddPerIndividualFile&lt;StylesheetBundle&gt;("Content");<br /></code></pre><br />Example 2 - Add two specific files under directory Content to a single bundle:<br /><br /><pre style="background-color: #eeeeee; border: 1px dashed #999999; color: black; font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; font-size: 12px; line-height: 14px; overflow: auto; padding: 5px; width: 100%;"><code>bundles.Add&lt;StylesheetBundle&gt;("Content", new[] {<br />                "Site.css",<br />                "smallmobile.css"<br />            });<br /></code></pre>note that the Content here is both an alias and the start of the file paths.<br /><br />Example 3 - Add two specific files under Scripts where the alias name is NOT the same as the start of the paths.<br /><br /><pre style="background-color: #eeeeee; border: 1px dashed #999999; color: black; font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; font-size: 12px; line-height: 14px; overflow: auto; padding: 5px; width: 100%;"><code>bundles.Add&lt;ScriptBundle&gt;("MsAjaxJs", new[]{<br />                "Scripts/WebForms/MsAjax/MicrosoftAjax.js",<br />                "Scripts/WebForms/MsAjax/MicrosoftAjaxWebForms.js"});<br /></code></pre>note that these include the base level Scripts folder name in their paths<br /><br />Example 4 - Add everything under directory Content but bundle them per sub-directory.<br /><br /><pre style="background-color: #eeeeee; border: 1px dashed #999999; color: black; font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; font-size: 12px; line-height: 14px; overflow: auto; padding: 5px; width: 100%;"><code>bundles.AddPerSubDirectory&lt;StylesheetBundle&gt;("Content");<br /></code></pre><br />Example 5 - Add the following files with a named marker to allow them to be rendered in a specific place on the page<br /><br /><pre style="background-color: #eeeeee; border: 1px dashed #999999; color: black; font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; font-size: 12px; line-height: 14px; overflow: auto; padding: 5px; width: 100%;"><code>bundles.Add&lt;ScriptBundle&gt;("PPMouse", new []{<br />                "Scripts/imageinject.js",<br />                "Scripts/jcanvas.min.js"},<br />                b =&gt; b.PageLocation = "mouse");<br /></code></pre>note this location is commonly going to be "head" or "body" to distinguish scripts which must be in the head from those that can be in the body. In this example, I used mouse because it is page specific and I don't want it rendered via the master page into every page on the site.<br /><br /><h3>Referencing</h3>Before you can render these scripts and css, you need to reference them. This causes Cassette to do various checking and processing on the files and generates their unique filenames for cache busting. Referencing is fairly straight-forward, as you can see from the following:<br /><br /><pre style="background-color: #eeeeee; border: 1px dashed #999999; color: black; font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; font-size: 12px; line-height: 14px; overflow: auto; padding: 5px; width: 100%;"><code>&lt;%@ Master Language="C#" AutoEventWireup="true" CodeBehind="Site.master.cs" Inherits="PixelPinControl.SiteMaster" %&gt;<br /><br />&lt;%<br />    Bundles.Reference("Content");            // Standard reference<br />    Bundles.Reference("Modernizr", "head");   // Reference from named position (head)<br />    Bundles.Reference("MsAjaxJs", "body");    // Two references from named position (body)<br />    Bundles.Reference("WebFormsJs", "body");<br />%&gt;<br /><br />&lt;!DOCTYPE html&gt;<br />&lt;html lang="en"&gt;<br />&lt;head runat="server"&gt;<br /></code></pre>note this doesn't render anything to the page at this position.<br />In order to then render the correct links, you use the Render method like the following:<br /><pre style="background-color: #eeeeee; border: 1px dashed #999999; color: black; font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; font-size: 12px; line-height: 14px; overflow: auto; padding: 5px; width: 100%;"><code>&lt;head runat="server"&gt;<br />    &lt;!-- snip --&gt;<br />    &lt;%: Bundles.RenderStylesheets() %&gt;<br />    &lt;%: Bundles.RenderScripts("head") %&gt;<br /></code></pre>In this example, we are rendering all style sheets (since we did not qualify the call to the RenderStylesheets) and then render only the scripts that are required in the head position. There is obviously a similar call in the body for the body scripts.<br /><h3>Page Specific Content</h3>When using page-specific content, simple ensure your bundles are separated correctly and&nbsp; then reference and render the content in the same place on your page. For example, my site uses a master page where the above code is used but I have a page which needs my mouse scripts and these are only allowed inside the content placeholders (body in my case):<br /><pre style="font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; color: #000000; background-color: #eee;font-size: 12px;border: 1px dashed #999999;line-height: 14px;padding: 5px; overflow: auto; width: 100%"><code>&lt;asp:Content runat=&quot;server&quot; ID=&quot;BodyContent&quot; ContentPlaceHolderID=&quot;MainContent&quot;&gt;<br />    &lt;% Bundles.Reference(&quot;PPMouse&quot;, &quot;mouse&quot;); %&gt;<br />    &lt;%: Bundles.RenderScripts(&quot;mouse&quot;) %&gt;<br /></code></pre><br />
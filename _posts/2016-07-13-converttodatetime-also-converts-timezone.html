---
layout: post
title: Convert.ToDateTime() ALSO converts the timezone!
date: '2016-07-13T04:02:00.001-07:00'
author: Luke Briner
tags:
- timezone
- DateTime
- Unexpected
- Convert
- Format
- ISO8601
modified_time: '2016-07-13T04:02:36.113-07:00'
---

Few things in programming sound as simple as dates but are so complicated. Partly I think previous companies have no appreciated the complexity and tried to simplify things and even Javascript still lacks basic operators like ToString(str) methods.<br /><br />Anyway, I am trying to display a date to the user in the browser-local timezone and format. This sounds easy enough, I render a UTC datetime to the page and then use the following javascript to render it into the locale sensitive format:<br /><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">$('#lastLoginDate').text(String.format(</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; $('[name="LastLoginFormat"]').val(),</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; <b>new Date(</b>$('[name="LastLogin"]'<b>)</b>.val())<b>.toLocaleDateString()</b>,</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; <b>new Date(</b>$('[name="LastLogin"]'<b>)</b>.val())<b>.toLocaleTimeString()</b>.slice(0, -3)</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; ));</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><br /></span><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">if (!String.format) {</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; String.format = function (format) {</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; var args = Array.prototype.slice.call(arguments, 1);</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; return format.replace(/{(\d+)}/g, function (match, number) {</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return typeof args[number] != 'undefined'</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ? args[number]</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : match</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; });</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; };</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">}</span><br /><br />The first bit is actually formatting the string to say "Last login <date> at <time>" and the slice function is simply to chop the seconds off from the time (important bits in bold). The second function is to provide String.format like it is in ASP.net. Thanks to <a href="http://stackoverflow.com/users/2733/fearphage" target="_blank">fearphage</a> for this code.</time></date><br /><br />This bit worked but the time was wrong and I suspected there was some timezone problem. I thought I was storing all dates in the database as UTC, since they are cloud servers and always stay in UTC without daylight savings. A quick check and this was accurate so what was going on?<br /><br />Well, I wanted to make sure that an ISO8601 was being passed as a string to javascript so I had the following:<br /><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">model.LastLogin = LastLogin.ToString("yyyy-MM-ddTHH:mm:ssZ");</span><br /><br />But it was wrong. So after a simple console app and some copies and pasting of the code I was using in my main app and the following was happening:<br /><br />(Web service from database)<br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">return Convert.ToDateTime(dataReader["lastlogin"]).ToString("u")</span><br /><br />This was correct and returned the string as UTC datetime as per the database.<br /><br />(Main app)<br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">LastLogin = Convert.ToDateTime(stringFromWebService);</span><br /><br />This was NOT correct. What was happening was that the UTC datetime was being converted into the local timezone on my development machine when this code was called. Why? Because I think it is wrong. It is making an assumption that I want the time to be local whereas the SAFE default would be to leave it with the UTC timezone and allow me to convert it later or provide other overloads to the function that would be more specific about whether the conversion should take place or not.<br /><br />The fix? I have to convert it BACK again by doing something like this:<br /><br /><span style="font-family: &quot;Courier New&quot;, Courier, monospace; font-size: x-small;">LastLogin = Convert.ToDateTime(stringFromWebService).ToUniversalTime();</span><br /><span style="font-family: &quot;Courier New&quot;, Courier, monospace; font-size: x-small;"><br /></span><span style="font-family: inherit;">Which is also poorly worded since it is really converting it to the Universal Time ZONE.</span><br /><span style="font-family: inherit;"><br /></span><span style="font-family: inherit;">I don't know whether we ever understand how all this date stuff works but it would be easier if the framework classes treated everything like UTC and only performed locale dependent stuff with specific functions like DateTime.ToTimeZone() or DateTime.ToLocalTimezone() or whatever.</span><br /><span style="font-family: inherit;"><br /></span><span style="font-family: inherit;">I'm trying to do the right thing with UTC but .net is not helping :-(</span><br /><br /><br />
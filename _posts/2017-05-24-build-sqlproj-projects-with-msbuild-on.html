---
layout: post
title: Build sqlproj projects with MSBuild on a Build Server
date: '2017-05-24T08:25:00.000-07:00'
author: Luke Briner
tags:
- compiler error
- Microsoft
- Error
- sqlproj
- ssdt
- v11.0
- msbuild
- target
- visual studio
- v15.0
modified_time: '2017-05-24T08:25:08.223-07:00'
---

God bless Microsoft, each time a new Visual Studio comes out, they make an improvement, like making the install directories more logical and allowing better side-by-side installations. The problem? Most of these are not backwards compatible and it creates a whole load of compatibility problems.<br /><br />Install VS 2017 and create a database project (sqlproj) in a solution. Open up the sqlproj file and you will see some really poorly thought out targets:<br /><br /><pre style="background-color: #eeeeee; border: 1px dashed #999999; color: black; font-family: &quot;andale mono&quot; , &quot;lucida console&quot; , &quot;monaco&quot; , &quot;fixed&quot; , monospace; font-size: 12px; line-height: 14px; overflow: auto; padding: 5px; width: 100%;"><code>&lt;PropertyGroup&gt;<br />    &lt;VisualStudioVersion Condition="'$(VisualStudioVersion)' == ''"&gt;11.0&lt;/VisualStudioVersion&gt;<br />    &lt;!-- Default to the v11.0 targets path if the targets file for the current VS version is not found --&gt;<br />    &lt;SSDTExists Condition="Exists('$(MSBuildExtensionsPath)\Microsoft\VisualStudio\v$(VisualStudioVersion)\SSDT\Microsoft.Data.Tools.Schema.SqlTasks.targets')"&gt;True&lt;/SSDTExists&gt;<br />    &lt;VisualStudioVersion Condition="'$(SSDTExists)' == ''"&gt;11.0&lt;/VisualStudioVersion&gt;<br />  &lt;/PropertyGroup&gt;<br /></code></pre><br />Basically, what this says is that if I don't know what the visual studio version is when I build, then I will assume that I should look for v11 (VS2012) directories and fail if I don't find them rather than what most people would do, which would be either to fail if the version is not passed in, or to hard-code the version you chose when you added the project.<br /><br />Run this on a build server with MSBuild instead of Visual Studio and you might see the following error:<br /><br /><span style="background-color: #f2f2f2; color: #333333; font-family: Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 11px;">The imported project "C:\Program Files (x86)\Microsoft Visual Studio\2017\BuildTools\MSBuild\Microsoft\VisualStudio\v11.0\SSDT\Microsoft.Data.Tools.Schema.SqlTasks.targets" was not found</span><br /><span style="background-color: #f2f2f2; color: #333333; font-family: Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 11px;"><br /></span>Which makes sense because I don't have VS2012 installed on the build server at all.<div><br /></div><div>I eventually realised the issue is that VS injects the version into the target whereas MSBuild does not. A simple parameter passed to MSBuild (<b>/p:VisualStudioVersion=15.0</b>) sorts that problem and tells it to use VS2017, which I have installed on the server, although only the Build Tools.</div><div><br /></div><div>I then get a different error:</div><div><br /></div><div><span style="background-color: #f2f2f2; color: #333333; font-family: Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 11px;">The imported project "C:\Program Files (x86)\Microsoft Visual Studio\2017\BuildTools\MSBuild\Microsoft\VisualStudio\v15.0\SSDT\Microsoft.Data.Tools.Schema.SqlTasks.targets" was not found</span></div><div><span style="background-color: #f2f2f2; color: #333333; font-family: Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 11px;"><br /></span></div>Well, it looks the same but this time it should work, since I have v15 installed. I had a look and sure enough, the SQL tools were not installed. Installations have changed in VS2017 and although I tried to install the Data Processing workload for the Build Tools, the option was not there. I installed the workload using the VS2017 community edition, checked for the target file, which was now there but the build failed again.<div><br /></div><div>Looking closer, I noticed that the path was <i>almost</i>&nbsp;correct. MSBuild uses the <b>BuildTools </b>subdirectory of 2017 whereas proper Visual Studio uses <b>community </b>(in my case). Basically, there is no obvious way to install SSDT into the Build Tools area, which is where MSBuild looks so instead I copied over the MSBuild\Microsoft\VisualStudio\v15.0\SSDT folder from community into buildtools (with its directory structure) and also&nbsp;copied over Common7\IDE\Extensions\Microsoft\SQL* directories, which are used by the sqlproj target and the build worked!</div>
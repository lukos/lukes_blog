---
layout: post
title: Encrypt web.config sections for Azure
date: '2013-04-26T06:39:00.000-07:00'
author: Luke Briner
tags:
- custom sections
- Azure
- pkcs12
- the configuration section system.net was not found
- aspnet_regiis
- web.config
- encrypted web config sections
modified_time: '2013-04-26T08:41:55.703-07:00'
---

<h2>Introduction </h2>Encrypting web.config sections that contain passwords is good, firstly as defence in depth (if someone was able to access your config files) but also, actually, is good practice in development teams where everyone does not need to know what the passwords are, it just raises the risk of something happening and not knowing who leaked the information out!<br /><br />Anyway, this is easy enough in ASP.net using aspnet_regiis.exe which somes with the framework and does various things including encrypting sections in web.config.<br /><h2>Quick Guide</h2><br />There is a good set of articles starting here: <a href="http://blogs.msdn.com/b/sqlazure/archive/2010/09/07/10058942.aspx" target="_blank">http://blogs.msdn.com/b/sqlazure/archive/2010/09/07/10058942.aspx</a> which describes having to do something slightly different when your site is hosted in Azure (the link is part 1 of 4 but there are no links to the next post so you need to click on September 2010 on the right to find the other parts). It involves downloading a custom encryption provider from <a href="http://code.msdn.microsoft.com/pkcs12protectedconfg" target="_blank">http://code.msdn.microsoft.com/pkcs12protectedconfg</a>, creating or buying an X509 (SSL) certificate which you should upload to Azure as you normally would (instructions in parts 1 and 2 of the guide). You then need to build the protectedconfig library and put it into the same directory as the web config that contains the sections you want to encrypt. You should also reference the dll in your project for use at runtime. You then modify the web config to add in the custom provider configuration like this:<br /><br /><pre style="background-color: #eeeeee; border: 1px dashed #999999; color: black; font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; font-size: 12px; line-height: 14px; overflow: auto; padding: 5px; width: 100%;"><code>&lt;configuration&gt;<br />  &lt;!-- everything else --&gt;<br /> &lt;configProtectedData&gt;<br />    &lt;providers&gt;<br />      &lt;add name="CustomProvider" thumbprint="ABC123etc..." type="Pkcs12ProtectedConfigurationProvider.Pkcs12ProtectedConfigurationProvider, PKCS12ProtectedConfigurationProvider, Version=1.0.0.0, Culture=neutral, PublicKeyToken=34da007ac91f901d" /&gt;<br />    &lt;/providers&gt;<br />  &lt;/configProtectedData&gt;<br />  &lt;!-- anything else --&gt;<br />&lt;/configuration&gt;<br /></code></pre><br />which tells the protected config which certificate to use for encryption/decryption (put the relevant thumbprint in the config section). This will need to be present both on the local machine and on the Azure service that you will be uploading to. Note, you do NOT need to declare this configuration section at the top of the web.config.<br />You then need to run the following command from a Visual Studio command prompt in the same directory as the web.config. Remember to make sure the pkcs12protectedconfig.dll is in the same directory: <b>aspnet_regiis -pef "connectionStrings" "." -prov "CustomProvider"&nbsp;</b><br />Note that you need to specify the section you need to encrypt in this command, otherwise the other options are the same as above.<br /><h2>Things to Note</h2>If you want to encrypt <b>your own custom section</b>, you have extra work. You need to install the dll that defines the configuration section into the GAC of your development machine, even if it is included in the project because aspnet_regiis will not look in the project to find it. You will then need to change the declaration of the section in web.config to include the GAC fields (culture, version, publickey token). After you have encrypted the section, you can uninstall the library from the GAC, change the config section back to a local reference and then <b>re-build your project</b> afterwards, otherwise the project will start to think the reference that was local is now global and it will break when you upload it. If you want to find the public key token of your dll, run <b>sn -T name.dll</b> from a Visual Studio command prompt.<br /><br />You cannot encrypt all sections, if you try, you might get an illogical error like "the configuration section 'system.net' was not found". In this specific example, you cannot encrypt the top-level entry but you CAN encrypt further down, for example: <b>aspnet_regiis -pef "system.net/mailSettings/smtp" "." -prov "CustomProvider"</b>
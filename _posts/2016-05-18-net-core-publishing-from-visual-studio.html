---
layout: post
title: ".Net Core - Publishing from Visual Studio 2015 - It's a pain"
date: '2016-05-18T09:53:00.000-07:00'
author: Luke Briner
tags:
- visual studio 2015
- IIS8
- node
- gulp
- ".Net Core"
- visual studio
- iis
- bower
- Publish
- Windows Server
modified_time: '2016-05-18T09:53:16.930-07:00'
---

tldr; Install .Net Core SDK RC2, run dnvm upgrade to setup dnu.exe if its not visible to the console, install bower and gulp using npm, run dnu publish against your project, copy files across to server, install HttpPlatformhandler on the server, setup site manually, set app pool to not use managed code<br /><h2>.Net Core</h2><div>So Microsoft's big announcement of the last few years is making ASP .Net better. When I say better, it means having much more pluggable functionality in the web pipeline. You no longer have to include everything that you might need, just what you do need. That has to be good for memory usage and page load times and makes cross-platform porting much more doable compared to the massive beast that is System.Web.dll</div><div><br /></div><div>You've heard of OWIN, the pluggable web server system. That is basically the pattern for .Net Core. You can use .Net on any server and any host, each layer being abstracted from the next. With traditional .Net, everything had a dependency on IIS i.e. Windows only, which meant that to port .Net, you had to write the entire stack for another platform.</div><div><br /></div><div>There are a whole load of features and differences between MVC5/Web Forms and .Net Core but for now, just imagine it is more modular and allows you to write MVC or Web API as well as anything else you want to write OWIN middleware for.</div><h2>Your First Project</h2><div>If you have Visual Studio 2015, Update 2, you should already have the templates for .Net Core. Depending on what exactly you have installed, they will either appear in the list underneath "ASP &nbsp;.Net Web Application" in the Web folder as "ASP .Net Core Web Application" or if you don't have the Core SDK, they will appear in the list <i>after</i>&nbsp;you select "ASP .Net Web Application" as ASP .Net 5 templates (.Net 5 was the old name for Core). Do not confuse .Net 5 with MVC 5 which was .Net 4!</div><h2>Publishing</h2><div>My reason for learning about Core was to look at some basic performance tests as an indication as to whether to start developing on Core now or wait a year or so. For this reason, I didn't want to modify the default code, just publish it and fire some load tests at it.</div><div><br /></div><div>Right-click the project and choose "Publish", I can see a publish dialog with only one option - "File system". Hmmm. Visual Studio apparently doesn't understand this project type and also doesn't know how to publish it. If you try, nothing gets published. As is often the case with new technology, there are lots of articles about doing things manually to fix it, from the previous betas and release candidates. I tried a few but no dice.</div><div><br /></div><div>Well, you can publish it from the command line using dnu.exe apparently (no idea what all these tools are). Tried that. dnu.exe is not recognised as an internal or external command... Apparently you have to run "dnvm upgrade" first to install it and setup the paths correctly. Done.</div><div><br /></div><div>Try again. "Bower" unknown command. I know what Bower is, I don't know why it is not installed. Maybe I need something else for Visual Studio. Oh, here is the <a href="https://www.microsoft.com/net/core#windows" target="_blank">installer </a>for .Net Core for Visual Studio 2015. Not sure why I already had the templates but no supporting tools installed. Anyway, installed it. dnu.exe still doesn't work - same error.</div><div><br /></div><div>One article said that if you run the tools from Visual Studio, it sorts all the paths out. The problem is, I can't - publish now doesn't work at all. If I select it, nothing happens. If I choose it from the Build menu, I get some weird dll error referencing an interface name that doesn't even exist on Google!</div><div><br /></div><div>Maybe I need to install bower manually. npm install bower. Great. 'Gulp' unknown command. Hmm. npm install gulp -g. OK. Ignore all the millions of errors but now - O dear - the dreaded npm on Windows bug - path too long. This is due to npm's incredibly sensible but completely rubbish idea to nest dependencies to avoid package conflicts. This leads to dependencies that are 10s deep.</div><div><br /></div><div>Groan. OK, move the project from Visual Studio Projects down into a lower level directory and try again. Now it seems to work and the project is published. What a ballache. Surely this should all happen automatically from Visual Studio. Version 1 of Core is supposed to drop in a month!</div><div><br /></div><div>OK. Now you have to copy the files to the web server manually (of course you do!). Web Deploy is supposed to work but doesn't seem to do anything at all. Setup your IIS web site as normal, point it at the wwwroot folder of your files and, importantly, set your application pool to NOT use managed code.</div><div><br /></div><div>Access the site. No dice, Internal Server Error 500.19. Why? Well, the documentation that I followed that made me install some exe on the server was obviously not what I needed to install. I think I read that MS changed it but, again, documentation is out of date (but not marked as such) so I needed to install the <a href="http://www.iis.net/downloads/microsoft/httpplatformhandler" target="_blank">HttpPlatformHandler</a>, which I then did. Didn't need to restart and the site now works.</div><h2>Conclusion</h2><div>Apart from all the promises of this great new technology stack, the tools are still woefully poor and the documentation is all over the place. They are probably scrambling to get things working but MS have succeeded quite well because most people can install, develop and publish without doing anything weird. Using Node Package Manager to install things that should work automatically in Visual Studio is just weird.</div><div><br /></div><div>At some point, I might even load test my new site!</div><div><br /></div><div><br /></div>
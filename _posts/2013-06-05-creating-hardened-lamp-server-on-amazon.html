---
layout: post
title: Creating a hardened LAMP server on Amazon Web Services (AWS)
date: '2013-06-05T02:28:00.001-07:00'
author: Luke Briner
tags:
- ssh
- hardening
- LAMP
- security
- Amazon
- aws
modified_time: '2013-06-05T02:28:23.269-07:00'
---

This has become something I have had to do a few times now and rather than keeping scratching my head to remember what to do, I thought I would describe the process of creating an Ubuntu LAMP stack on AWS which is never unnecessarily exposed to the web before it is hardened.<br /><br />Firstly, create a new security group. It should have only the ssh port enabled on 22 and be locked down only to your public IP address, it can also have the rule for your eventual ssh port added, either open to the whole world (if like me you move around a lot) or your company/home public IP(s) if you usually only access it from one place.<br /><br /><img alt="" src="data:image/png;base64,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" /> <br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://www.blogger.com/blogger.g?blogID=1853560974103500506" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"></a></div>Note that in the above image, it also shows the public ports 80 and 443 that eventually added for my web server, you can choose not to add these now but it is up to you. Since you will probably have a fairly hardened version of apache installed by default, it is not a big deal either way. In the case of port 22, note that I added my public ip address and a subnet mask of 32, this locks it down to only that one ip address. If you want a range of ip addresses in the rule, the subnet mask is the number of binary ones in the subnet mask. For instance, the common subnet mask of 255.255.255.0 is equivalent to 24 1s and would restrict the rule to any ip address between A.B.C.0 and A.B.C.255. Note also, the port I have coloured over is the port I use for ssh (it is a 4 digit number way up there) and this prevents a massive amount of ssh attacks which are launched against port 22<br /><br />Once your security group is setup, create your new Ubuntu instance (the same instructions will be pretty much true of most Linux distros). And then choose to create a new key-pair or use an existing one if you have one - I prefer to create multiple keys to reduce the chance of one being stolen/obtained and used to access all systems, despite the slight additional hassle of this. Obviously choose to use your new security group for this new instance. You could alternatively have a security group you use for all new instances and then a second group to use once the instance has been hardened.<br /><br /><a href="http://www.blogger.com/blogger.g?blogID=1853560974103500506" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"></a>Run up the new instance and connect to it. If you are connecting from Linux, you will need to add the private key for the instance to your ssh keys (there are plenty of guides but you probably already know how to do this anyway). If you are using Windows, you can use Putty but you first need to use Puttygen to convert the downloaded PEM into a Putty PPK since Putty has its own key format for some very annoying reason. To do this, run puttygen and File-Load Private Key. Change the file filter to *.* and find your key.pem and select it, putty gen will automatically import it and then you have to choose Save Private Key and add an optional passphrase - this would mean that even if someone else had access to the key e.g. access to a shared pc, they would still need the passphrase to connect.<br /><br />Once you have generated the ppk file for the key (and added an optional passphrase to it), you can create a Putty session that uses the public dns for your instance and port 22. You then need to set the key under Connection-SSH-Auth in the private key file box. Note, the aws instances do not allow password access by default - which is good - so if you do not specify the key (or an incorrect one) when you try and connect, you will get a console error which says Permission Denied (publickey). If your firewall rule is using the wrong ip address, you will get a dialog saying Permission Denied when you attempt to connect from Putty.<br /><br />Once you are in, the first thing I always do is to run<b> sudo apt-get update</b> and <b>sudo apt-get upgrade</b> to get any package updates before I do anything else.<br /><br />The next thing to do is to <b>sudo nano /etc/ssh/sshd_config</b> which will change the configuration for the ssh daemon. When you edit this, the first thing you want to do is move the default port from 22 to, let's say, 8989 which is not standard and so is unlikely to be be attacked. There are a couple of other things to do like disable PasswordAuthentication (set it to no) and ensure that PermitRootLogin is also set to no since you will not be able to login as root anyway (the private key uses the pre-created user "ubuntu") and this adds another defence against an attacker who could otherwise do anything that root can do on the box. Once you have edited and saved it, <b>sudo service ssh restart</b> and then <b>ctrl-d</b> to log off. Now the port will have changed and your current putty session will no longer be able to connect. If you have not yet done so, you can remove your port 22 from your security group, change to a new security group and/or add a rule for your new port optionally locked down to specific hosts.<br /><br />You can now edit your Putty config and point it at the new port (and save your settings). When you connect again, you will get another warning about trusting the servers key which you can go past and you should be into your box again.
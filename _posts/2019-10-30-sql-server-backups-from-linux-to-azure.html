---
layout: post
title: SQL Server Backups from Linux to Azure Blob Storage
date: '2019-10-30T04:29:00.001-07:00'
author: Luke Briner
tags:
- backup
- sql server
- Hallengren
- linux
modified_time: '2019-10-30T04:31:00.716-07:00'
---

So I have a few specifics here that might make this harder than it would otherwise be:<br /><br />1) SQL Server running on Linux (Ubuntu) in an Azure VM<br />2) Backing up to Azure blob storage<br />3) Using the amazing <a href="https://ola.hallengren.com/sql-server-backup.html" target="_blank">Hallengren helper scripts</a> for backups<br />4) Scheduling these from SQL Agent jobs (the ones that get created when you run the Hallengren install script) <br /><br />So here is how to make it work.<br /><h3>Azure Storage</h3>Nothing too funky here, just create a normal storage v2 account and make it public (the container will be private). I don't know if the problems I had previously on private storage accounts were because they were private or because of something else that I have now fixed.<br /><br />Create a Shared Access Signature for your SQL server to access the account with. These are nice because they are time-limited and affect the scope of what the token can perform. I only allowed blob access and removed the delete permission. You can optionally lock this down to an IP address. I gave mine 1 year but remember that you need a regular job to rotate these and if the access key is changed, these will stop working.<br /><br />Copy the SAS WITHOUT the leading ? character.<br /><br />Create a <i>private</i> container to store your backups in in the <b>blob service</b> section of the blade.<br /><h3>SQL Server Prep</h3>Install the Hallengren scripts. This will create stored procs and some SQL agent jobs (if you haven't already, you might need to <a href="https://docs.microsoft.com/en-us/sql/linux/sql-server-linux-setup-sql-agent?view=sql-server-ver15" target="_blank">enable this</a> on Linux). By default, they are installed into master.<br /><br />Create a credential for use with an SAS by following <a href="https://docs.microsoft.com/en-us/sql/relational-databases/backup-restore/sql-server-backup-to-url?view=sql-server-ver15#Examples" target="_blank">this</a>. Note that the following code will ONLY work for SAS. If you are using the access key, see the alternate instructions in the linked article.<br /><br /><span style="font-size: x-small;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">IF NOT EXISTS&nbsp; <br />(SELECT * FROM sys.credentials&nbsp;&nbsp; <br />WHERE name = 'https://<mystorageaccountname>.blob.core.windows.net/<mystorageaccountcontainername>')&nbsp; <br />CREATE CREDENTIAL [https://<mystorageaccountname>.blob.core.windows.net/<mystorageaccountcontainername>] <br />&nbsp;&nbsp; WITH IDENTITY = 'SHARED ACCESS SIGNATURE',&nbsp; <br />&nbsp;&nbsp; SECRET = '<sas_token>';&nbsp; </sas_token></mystorageaccountcontainername></mystorageaccountname></mystorageaccountcontainername></mystorageaccountname></span></span><br /><br />Note that the identity must equal "SHARED ACCESS SIGNATURE", you cannot change that part. Remember to paste the SAS token WITHOUT the leading ? character.<br /><h3>Calling the Backup Script</h3>The SQL Agent jobs created by the Hallengren script are designed for local backup to a directory. Instead, you should change the SQL that is called from the job to look like the following:<br /><br />&nbsp;EXECUTE [dbo].[DatabaseBackup]<br />@Databases = 'USER_DATABASES',<br />@URL = 'https://name.blob.core.windows.net/container',<br />@BackupType = 'FULL',<br />@Compress = 'N',<br />@Verify = 'Y'<br /><br />But obviously check that the individual settings are correct for your job (full, partial etc). Note that there is an issue with @Compress in that it only works for certain versions of SQL Server and it was not supported on mine. You can always try Compress='Y' and you will simply get an error if it is not supported.<br /><br />Do NOT use the @Credential parameter when using SAS, it will automatically find the correct credential from the URL. <br /><br />When you run the script manually, you should see some output including any error messages and the actual command that is generated by the script. This should be enough to work out any problems with the script and there are certain limits like max database size and other options that are not supported when backing up to blob storage.
---
layout: post
title: Backup Amazon EC2 Linux box to S3 Storage
date: '2014-05-13T03:44:00.001-07:00'
author: Luke Briner
tags:
- backup
- command-line
- Amazon
- linux
- S3
- EC2
- aws
modified_time: '2014-05-13T03:44:41.393-07:00'
thumbnail: http://4.bp.blogspot.com/-76bbgCKWCGM/U3HdsuyIcXI/AAAAAAAAAos/KTtPOfwS2dE/s72-c/Capture.PNG
---

I'm looking for a simple and cheap way to backup my web servers to disk and there are obviously some options. SpiderOak has a free low tier and although it has certain features, such as full encryption and various ways to get at your data, I have found it to be unreliable, sometimes it never finishes and requires a machine reboot. Also, it never deletes anything so as time goes by, your allowance is eaten up and attempting to delete these old versions using the command line, although simple in theory, seems to lock up or fail more often than not.<br /><br />I thought I would set up a backup from the boxes directly to S3 storage which is cheap and local to the AWS boxes.<br /><br /><h3>1) Get the box in a known-good state, install s3cmd and take a snapshot.</h3><div>This is just good practice. Before I start mucking around with things, if I back everything up as a snapshot, I can go back to the start if I get anything wrong. So:</div><div><br /></div><div><span style="font-family: Courier New, Courier, monospace;">&gt; sudo apt-get update &amp;&amp; sudo apt-get upgrade</span></div><div><span style="font-family: Courier New, Courier, monospace;">&gt; sudo apt-get install s3cmd</span></div><div><span style="font-family: Courier New, Courier, monospace;">&gt; sudo reboot now</span></div><div><br /></div><div>Next, go into your AWS management portal and click on Volumes under the Elastic Block Store:</div><div><br /><div class="separator" style="clear: both; text-align: left;"><a href="http://4.bp.blogspot.com/-76bbgCKWCGM/U3HdsuyIcXI/AAAAAAAAAos/KTtPOfwS2dE/s1600/Capture.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-76bbgCKWCGM/U3HdsuyIcXI/AAAAAAAAAos/KTtPOfwS2dE/s1600/Capture.PNG" /></a></div><div class="separator" style="clear: both; text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: left;">Select the volume that is attached to your instance (you can see this in the Attachment Information column) and under the actions menu, choose Create Snapshot. This happens as a background process, so you don't need to wait for it.</div><div class="separator" style="clear: both; text-align: left;"><br /></div><h3 style="clear: both; text-align: left;">2) Setup Amazon S3 and get the credentials</h3><div>Skip this section if you already have S3 setup and you know the credentials (you might however want to create an additional bucket for your backups)</div><div><br /></div><div>Click on the S3 icon in the AWS management portal, either from the front page or under the Services Menu. If you have not already done so, click Create Bucket and give it a useful name. When choosing a region, it will be cheaper and quicker to use the same region as your instances but it will be much more secure to write it to another region so the chance of losing the server and the storage at the same time is much lower. Personally, I prefer the local faster option and will take a chance on the whole data center not getting destroyed! (You could also run a job to duplicate the bucket to another region but I'm not going to do that here).</div><div><br /></div><div>It is good practice to add a user just for uploading backups. This user can be restricted to an appropriate level so that it someone compromised the machine/user the damage they could do is limited. By default, I will not allow this user to view, only to upload. I can add the view permission if I ever need to restore from backup.</div><div><br /></div><div>To add a new user, click on the IAM icon under the services menu, which opens the Identity and Access Management control panel. Click on Users and Create New Users. Enter a name (such as backup) and copy the access key and secret key from the dialog that comes up. Note that these keys are like passwords. Do not publish them and do NOT put them in source code in a public repository. It has happened and attackers can find them and sometimes use them to create instances (often for Bitcoin mining!) at your expense. Note that you cannot re-download these, so if you haven't copied or downloaded them, you would need to recreate them at a later date.</div><div><br /></div><div>You can now create a group and give it access to your S3 bucket. This makes it easier to add additional users later on for other machines. Click Groups and Create New Group. Give it a name (like backup) and then press Continue. The next page links this group to certain permissions on a certain resource. You could use a present template but the policy generator option allows more fine-grained control so click that radio button and press Select. As with many permissions, this allows an allow or a deny policy to be created. Since this is our first policy, we will choose Allow and then select Amazon S3 as the AWS Service. Under actions, I selected Put Object, Delete Object, List Objects, Get Object and List Bucket. I'm not sure yet whether all of these are required but you definitely need List Bucket for the s3cmd setup to work. Once you have chosen the actions, you need to specify which resource these permissions apply to <span style="font-family: inherit;">using Amazon Resource Notation. In this case, the format is&nbsp;<span style="background-color: #eeeeee; color: #000066;">arn:aws:s3:::</span><em class="replaceable" style="color: red;">bucketname </em><span class="replaceable">where bucketname is the bucket you created earlier. You need to extend this for the sub directories of the bucket name but rather than adding another nearly identical statement, we will edit the policy after the group is created.</span></span></div><div><span style="font-family: inherit;"><span class="replaceable"><br /></span></span></div><div><span style="font-family: inherit;"><span class="replaceable">Once the statement has been added,&nbsp;</span></span><span style="font-family: inherit;">you will need to add a global permission since s3cmd needs to be able to list all buckets. Use 'Allow', 'Amazon S3' and ListAllMyBuckets for the Action. In the resource name, put&nbsp;</span>arn:aws:s3:::* and then click Add Statement.</div><div><br /></div><div>Once you press Continue and the group is created, we need to edit part of the permission policy since the permissions only currently apply to the bucket itself, not its contents. Click the Permissions tab at the bottom and next to the first policy statement, click Manage Policy. This should bring up an editor that has the permissions for the resource arn:aws:s3:::bucketname. Edit the resource block and add a comma after the existing entry and add another entry for "arn:aws:s3:::bucketname/*" so it looks like this:</div><div><br /></div><div><blockquote class="tr_bq">"Resource": [<br />&nbsp; &nbsp; &nbsp; &nbsp; "arn:aws:s3:::bucketname",<br />&nbsp; &nbsp; &nbsp; &nbsp; "arn:aws:s3:::bucketname/*"<br />&nbsp; &nbsp; &nbsp; ]</blockquote></div><div><br /></div><div>And press Apply Policy</div><div><br /></div><div><span style="font-family: inherit;"><span class="replaceable">Once the policy is updated, select it and click the Users tab at the bottom and Add Users to Group. Add the user you created earlier. This should be all you need to access your storage account using those user credentials.</span></span></div><div><span style="font-family: inherit;"><span class="replaceable"><br /></span></span></div><h3>3) Setup s3 tools on your box</h3><div>&gt; s3cmd --configure</div><div><br /></div><div>Enter your access key and secret followed by an encryption password. Encryption will be slower but you should never really trust a cloud storage unit to be secure from either nosey governments or people who might find a vulnerability in the cloud service. Enter the path to gpg (I selected the default), also say Yes to https. It is obviously important to test access so allow s3 tools to do this and fix any errors you get.</div><div><br /></div><div>If you get a 403, you might not have setup the permissions correctly or, obviously, you might have mistyped your key and secret. If all goes well, you should see something like:</div><div><br /></div><div><blockquote class="tr_bq">Please wait...<br />Success. Your access key and secret key worked fine :-)<br />Now verifying that encryption works...<br />Success. Encryption and decryption worked fine :-)<br />&gt; Save settings? [y/N] y<br />Configuration saved to '/home/ubuntu/.s3cfg'</blockquote></div><div><br /></div><div>That should be the setup finished correctly.</div><div><br /></div><h3>4) Setup your sync</h3><div>s3cmd acts a bit like an FTP program and can copy, delete, list objects and buckets etc. Most of these commands are very intuitive (and full details can be found <a href="http://s3tools.org/usage" target="_blank">here</a>):</div><div><br /></div><div>List buckets</div><div><b>&gt; s3cmd ls</b></div><div><br /></div><div>Copy between buckets</div><div><b>&gt; s3cmd cp s3://bucket1 s3://bucket2</b></div><div><br /></div><div>Upload (put) local file into s3 bucket</div><div><b>&gt; s3cmd put filename s://bucketname</b></div><div><br /></div><div>Download a file</div><div><b>&gt; s3cmd get s3://bucket/filename localfilename</b></div><div><br /></div><div>But most importantly for us is probably the sync command:</div><div><br /></div><div><b>&gt;&nbsp;s3cmd sync directory s3://bucket/</b></div><div><br /></div><div>This will initially upload all files from the directory but then only new or changed files. If you want to delete remote files that have been deleted locally, use the --delete-removed option.</div><div><br /></div><div>Note that sync does NOT use encryption currently. If you want encryption, you need to use put with the -e and --recursive options. I will write another post if I can work out a practical backup solution which includes encryption, only uploads increments (i.e. only the changes) and allows easy storage of multiple backups (perhaps each day for a week and then 4 weeks and then 3 months etc).</div><br /></div>
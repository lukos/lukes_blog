---
layout: post
title: Backing up Linux box to online storage for cheap!
date: '2014-05-21T03:36:00.001-07:00'
author: Luke Briner
tags:
- tutorial
- cron.d
- backup
- s3cmd
- setup
- S3
- cron
modified_time: '2014-05-21T03:36:26.781-07:00'
---

In my <a href="http://lukieb.blogspot.co.uk/2014/05/backup-amazon-ec2-linux-box-to-s3.html" target="_blank">previous post</a>, dear Theophilus, I described how to setup Amazon S3 storage and how to install s3tools in order to sync files to online. In this post, I will describe the mechanism I ended up with to backup various Linux boxes, mostly web servers, to S3 storage.<br /><br /><h2>1) Setup S3 etc.</h2>Already covered in the <a href="http://lukieb.blogspot.co.uk/2014/05/backup-amazon-ec2-linux-box-to-s3.html" target="_blank">previous post</a><br /><h2>2) Install rsync</h2><span style="font-family: 'Courier New', Courier, monospace;">sudo apt-get install rsync</span><br /><h2>3) Create a script file to run the backup</h2>Just using nano or your favourite text editor, create a script file, which will look like the following:<br /><br /><pre>#!/bin/bash<br />BACKUPDIR="/home/luke/backupdir" &nbsp; &nbsp;#temp directory for backup files<br />TAROUTPUT="/home/luke/backup.tar" &nbsp; #backup output temp file<br /><br />echo "Starting server backup..." &nbsp; &nbsp;# Useful for emails<br />date&nbsp;+%H%M # Echoes the time to the console<br /><br /># Create temp dir if not exists<br />if [[ ! -d $BACKUPDIR ]]; then<br />        mkdir $BACKUPDIR;<br />fi<br /><br />#Apache configs<br />cp /etc/apache2/sites-available/default $BACKUPDIR<br /># other configs<br /><br />#ssl certs<br />cp /etc/ssl/certs/mycert.crt $BACKUPDIR<br /># other certs<br /><br />#sites<br />rsync -az /home/luke/sites/bugtracker $BACKUPDIR<br /><br />#postfix<br />rsync -az /etc/postfix $BACKUPDIR<br /><br />#run mysql dump<br />mysqldump -u root --password='mypassword' --all-databases &gt; $BACKUPDIR/mysqldump.sql<br /><br />#Create tar archive from the temporary directory contents, delete existing first<br />if [[ -f $TAROUTPUT ]]; then<br />    rm $TAROUTPUT<br />fi<br /><br />tar -czf $TAROUTPUT $BACKUPDIR &gt; /dev/null<br /><br />#upload and encrypt to s3 storage<br />s3cmd put -e $TAROUTPUT s3://myserverbackups/backup-myservername-$(date +%Y%m%d-%H%M)$<br /><br />date +%H%M<br /><br />echo "-----"<br />echo "Server backup complete"<br />exit 0<br /></pre><h2>4) Things to note</h2>a) Naturally, you can copy whatever you want to the backup directory before it is tar-ed. Be careful about directories or files that might have the same name. Usually, this will cause an error but potentially you could overwrite something.<br />b) use rsync for moving any large directories since it will only update files that have changed, meaning subsequent updates are usually very fast<br />c) I don't use the tar --update function since rsync appears to touch all files when checking them, which means tar thinks all the files have changed even if they haven't, which makes the tar grow each time.<br />d) s3cmd doesn't support encryption when using its sync function. This means if you need encryption (which I do) you have to put the whole tar archive each time. If you don't want/need encryption, then it would probably be quicker for you not to use tar but to use "s3cmd sync" between the backup dir and your s3 storage, which will make it much quicker<br />e) In the script above, I use my server name and the current date and time in the uploaded backup file to distinguish it from other backups that end up in the same place. Replace the filename with whatever you want. Note also that the bucket name, after the s3:// should be your bucket name from your S3 account.<br /><h2>5) Make the script runnable</h2>chmod&nbsp;+x ./myscript<br /><h2>6) Test it</h2>If you are planning to run this as your own user, then simply type ./myscript and see that it all runs as expected. If you are planning to run it from cron.d (the cron daemon which runs automatically) then it will run as root. This means two things, firstly, you need to configure s3cmd for root and secondly you need to test the script by running it as root. The easiest way is:<br /><br /><span style="font-family: Courier New, Courier, monospace;">sudo -i</span><br /><span style="font-family: Courier New, Courier, monospace;">s3cmd --configure</span><br />(do whatever you need to configure s3cmd and make sure it tests OK)<br /><span style="font-family: Courier New, Courier, monospace;">/path/to/myscript</span><br /><br />All things being well, this should run to completion and prove that the script is OK.<br /><h2>7) Setup cron to run the script</h2>The cron daemon is designed to run scripts at regular intervals, your system will already run a whole host of things that rotate logs, check for updates etc. It is very easy to set this up.<br /><br /><span style="font-family: Courier New, Courier, monospace;">sudo nano /etc/cron.d/myscript</span><br /><br />to create a new script in the cron.d directory. This has the crontab format and will be setup to call your script from wherever it is. Remember, this will run as the root user! You can copy in the crontab comments from another script if you want but the two lines you need in the script are:<br /><br /><span style="font-family: Courier New, Courier, monospace;">MAILTO=emailaddresstosendresultsto@mycompany.com</span><br /># Note by default, the script will email root@localhost, which may or may not resolve to anything useful<br /><span style="font-family: Courier New, Courier, monospace;">0 23 * * * &nbsp; &nbsp; /path/to/myscript</span><br /><br />The first line is self-explanatory and the comment says why, the second line calls the script but the start of the line defines the schedule to use to run the script. The example above has minutes = 0 and hours = 23 followed by 3 asterisks, which means it will run at 23:00 every day. The 3 stars are optional specifiers for the Day of month (only run on the x of the month), Month (only run during a certain month) and Day of Week (Only run on specific day of the week). There is plenty of online help for crontab which explains these in more detail if you care.<br /><h2>8) Sit back and wait</h2>All things working correctly, you should get an email after the script runs with the output of your script, any errors and any information you have echoed to the console.
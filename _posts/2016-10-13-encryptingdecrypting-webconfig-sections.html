---
layout: post
title: Encrypting/Decrypting Web.config sections with PKCS12
date: '2016-10-13T05:23:00.002-07:00'
author: Luke Briner
tags:
- encryption
- pkcs12
- web.config
modified_time: '2017-05-11T02:39:42.337-07:00'
---

<h2>What is it?</h2>I'm not sure why I haven't blogged this before, since it can be quite confusing but this is a cool way of protecting web.config secrets from being seen casually by Developers.<br /><br />The basic idea is that you use an SSL certificate as the key and then the sections in web.config are not readable. They will decrypt automatically, however, when used by IIS if the certificate is installed locally.<br /><br />It is worth mentioning that if a developer can run the code locally, they will still be able to find out the secrets, it is more of a protection from people who can see code in a repository but not run it.<br /><br />You can use any SSL/PKCS12 certificate for encryption/decryption but I recommend using a self-signed certificate that should be in-date (since some services e.g. Azure App Services will not allow upload of expired certificates). If you use a self-signed certificate, you get to control its lifetime more easily if you are worried about it being hacked. If you share one of your public certs, you will probably have more work to do when the cert expires.<br /><br />You should be able to encrypt all web config sections but although this works in theory, certain sections cannot be encrypted due to when they are accessed by the system. I can't find a useful resource so you will have to try it and see. It will be obvious if a section fails to decrypt.<br /><h2>So how do you do it?</h2>First, you should reference or install&nbsp;Pkcs12ProtectedConfigurationProvider, which does exist as a NuGet package.<br /><br />You then use aspnet_regiis.exe, which lives in the .Net framework directory(ies) in C:\Windows\Microsoft.Net. If you use the Visual Studio Developer Command Prompt, then this program should be in the path already.<br /><br />Make sure you run the command prompt as Administrator, otherwise you will not be able to run gacutil and asp_regiis will return the error "Keyset does not exist" because it will not have permission to access the local certificate store.<br /><br />So how does it know which certificate to use to encrypt? You need to create a section in your web config that references the thumbprint of the certificate you want to use. It looks like this:<br /><br /><pre>&lt;configprotecteddata&gt;<br />    &lt;providers&gt;<br />        &lt;add name="CustomProvider" thumbprint="d776576a90b5c345f8a9d94e732c86c1076eff78" type="Pkcs12ProtectedConfigurationProvider.Pkcs12ProtectedConfigurationProvider, PKCS12ProtectedConfigurationProvider, Version=1.0.0.0, Culture=neutral, PublicKeyToken=34da007ac91f901d"&gt;<br />    &lt;/add&gt;&lt;/providers&gt;<br />&lt;/configprotecteddata&gt;<br /></pre><br />aspnet_regiis performs various other functions as well but the two options we are interested in are:<br /><br />-pe to encrypt a section<br />-pd to decrypt it.<br /><br />If you use the f option as well, you can specify a physical location for a web.config, which I have found is easier than using the VirtualPath (and in some cases you won't have virtual path).<br /><br />The -f should point to the <i>directory</i> containing the web.config, not the web.config file itself. You will end up with a command like this:<br /><br />aspnet_regiis.exe -pef "connectionStrings" "C:\Users\luke\Documents\Visual Studio 2015\Projects\SolutionFolder" -prov "CustomProvider" <br /><br />Note that prov specifies the name of the key entry that you want to use to encrypt the section.<br /><br />If you are encrypting a custom section, you might have some fun and games trying to get aspnet_regiis to find and load the dll that defines the config section. You can use gacutil to add these dlls to global assembly cache and then use the correct version and public key (which you can find in a tool like ILSpy or by browsing to the Gac at c:\windows\microsoft.net\assembly\gac_msil and looking at the folder name for your dll e.g. v4.0_1.0.0.0__34da007ac91f901d) so that aspnet_regiis knows to look for the dll in the gac.<br /><br />If your section is not at the top level, you need to specify it like system.web\mysection. Also, some sections cannot be encrypted, which I think is because they are needed before it would be possible to run the decryption in IIS.<br /><br />Sometimes, it pretends to work but doesn't. Run it again, it sometimes catches up! Google any errors, they are fairly easy to work out.<br /><br />You will then end up with a section of the same name but with a reference to the customProvider you are using and an XML encrypted packet.<br /><br />Remember to upload the certificate you are using to any systems that will need to read the section otherwise you will quickly get an error!<br /><br />And as always, start with a really simple example and make sure it works before going crazy and trying to encrypt everything.
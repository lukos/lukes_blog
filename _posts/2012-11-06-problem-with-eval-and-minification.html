---
layout: post
title: Problem with eval() and minification
date: '2012-11-06T06:22:00.000-08:00'
author: Luke Briner
tags:
- eval
- minification
- javascript
- cassette
modified_time: '2012-11-06T06:22:29.541-08:00'
---

After using Cassette for minification, I found a script error when I built the site in release which went away in debug. Of course, in debug, the minification is occuring and what was happening related to the following Microsoft code:  <pre style="font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; color: #000000; background-color: #eee;font-size: 12px;border: 1px dashed #999999;line-height: 14px;padding: 5px; overflow: auto; width: 100%"><code>function ValidatorOnLoad() {<br />    if (typeof(Page_Validators) == &quot;undefined&quot;)<br />        return;<br />    var i;<br />    var val;<br />    for (i = 0; i &lt; Page_Validators.length; i++) {<br />        val = Page_Validators[i];<br />        if (typeof(val.evaluationfunction) == &quot;string&quot;) {<br />            eval("val.evaluationfunction = " + val.evaluationfunction + ";");<br />        }<br /></code></pre> What is happening here is that because of the overloaded and confusing use of the evaluationfunction property, the code is executed using eval(). The problem during minification is that the variable val is renamed to something smaller, let's say 'n' and the code effectively becomes:  <pre style="font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; color: #000000; background-color: #eee;font-size: 12px;border: 1px dashed #999999;line-height: 14px;padding: 5px; overflow: auto; width: 100%"><code>function ValidatorOnLoad() {<br />    if (typeof(Page_Validators) == &quot;undefined&quot;)<br />        return;<br />    var i;<br />    var n;<br />    for (i = 0; i &lt; Page_Validators.length; i++) {<br />        n = Page_Validators[i];<br />        if (typeof(n.evaluationfunction) == &quot;string&quot;) {<br />            eval("val.evaluationfunction = " + n.evaluationfunction + ";");<br />        }<br /></code></pre> The val inside the quotes is (understandably) untouched and the error occurs because val is undefined. I tried various things like getting the MS minifier to use one of its properties which says to ignore the minification of functions that contain eval() but this didn't work, I then changed to use the Yahoo minifier (YUI Compressor) to achieve the same thing but still no dice. It looked the function was sort of left alone but some changes were still made which broke it. In the end I had to rewrite the eval statement to work in a way that was minifier friendly. I ended up with this:  <pre style="font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; color: #000000; background-color: #eee;font-size: 12px;border: 1px dashed #999999;line-height: 14px;padding: 5px; overflow: auto; width: 100%"><code>function EvaluateStringFunction(func)<br />{<br />    var t;eval(&quot;t = &quot;+func+&quot;;&quot;);return t;<br />}<br />function ValidatorOnLoad() {<br />    if (typeof(Page_Validators) == &quot;undefined&quot;)<br />        return;<br />    var i;<br />    var val;<br />    for (i = 0; i &lt; Page_Validators.length; i++) {<br />        val = Page_Validators[i];<br />        if (typeof(val.evaluationfunction) == &quot;string&quot;) {<br />            val.evaluationfunction = EvaluateStringFunction(val.evaluationfunction);<br />        }<br /></code></pre> What you can see is that by returning the result of the evaluation via a function return, it avoids the ambiguity of the use of val.evaluation function and this is minifier friendly. It seems that the minifier will not rename the var inside the new function which means it should always match the t which is assigned to in EvaluateStringFunction().